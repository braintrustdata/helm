suite: test Brainstore serviceaccount template
templates:
  - brainstore-serviceaccount.yaml
tests:
  - it: should render Brainstore serviceaccount with default values
    values:
      - __fixtures__/base-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: brainstore

  - it: should use correct namespace from helper when createNamespace is false
    values:
      - __fixtures__/base-values.yaml
    set:
      global.namespace: "custom-ns"
      global.createNamespace: false
    release:
      namespace: "release-namespace"
    asserts:
      - equal:
          path: metadata.namespace
          value: release-namespace

  - it: should use global namespace when createNamespace is true
    values:
      - __fixtures__/base-values.yaml
    set:
      global.namespace: "custom-ns"
      global.createNamespace: true
    release:
      namespace: "release-namespace"
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-ns

  - it: should include AWS IAM role annotation when cloud is aws
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/aws-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
          value: arn:aws:iam::123456789012:role/test-brainstore-role

  - it: should include Azure workload identity annotation when cloud is azure
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: metadata.annotations["azure.workload.identity/client-id"]
          value: test-brainstore-client-id

  - it: should include GCP service account annotation when cloud is google
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/google-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]
          value: test@project.iam.gserviceaccount.com

  - it: should not include cloud-specific annotations when cloud is empty
    values:
      - __fixtures__/base-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - isNull:
          path: metadata.annotations["eks.amazonaws.com/role-arn"]
      - isNull:
          path: metadata.annotations["azure.workload.identity/client-id"]
      - isNull:
          path: metadata.annotations["iam.gke.io/gcp-service-account"]

  - it: should merge global and brainstore labels
    values:
      - __fixtures__/base-values.yaml
    set:
      brainstore.labels.component: "brainstore"
      global.labels.environment: "production"
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: metadata.labels.environment
          value: production
      - equal:
          path: metadata.labels.component
          value: brainstore

  - it: should include custom serviceaccount annotations when provided
    values:
      - __fixtures__/base-values.yaml
    set:
      brainstore.serviceAccount.annotations:
        custom-annotation: "value"
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: value
