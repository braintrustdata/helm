suite: test label merge isolation for service accounts (deepCopy fix)
templates:
  - api-serviceaccount.yaml
  - brainstore-serviceaccount.yaml
tests:
  # These tests verify the deepCopy fix for service accounts.
  # Without deepCopy, labels would bleed between components due to merge mutation.

  - it: should give API service account only global and api-specific labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.shared: "global-sa"
      api.labels.api-specific: "api-sa"
      brainstore.labels.brainstore-specific: "brainstore-sa"
    release:
      namespace: "braintrust"
    template: api-serviceaccount.yaml
    asserts:
      - equal:
          path: metadata.labels.shared
          value: global-sa
      - equal:
          path: metadata.labels["api-specific"]
          value: api-sa
      - isNull:
          path: metadata.labels["brainstore-specific"]

  - it: should give Brainstore service account only global and brainstore-specific labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.shared: "global-sa"
      api.labels.api-specific: "api-sa"
      brainstore.labels.brainstore-specific: "brainstore-sa"
    release:
      namespace: "braintrust"
    template: brainstore-serviceaccount.yaml
    asserts:
      - equal:
          path: metadata.labels.shared
          value: global-sa
      - equal:
          path: metadata.labels["brainstore-specific"]
          value: brainstore-sa
      - isNull:
          path: metadata.labels["api-specific"]
