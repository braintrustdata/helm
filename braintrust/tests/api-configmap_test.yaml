suite: test API configmap template
templates:
  - api-configmap.yaml
tests:
  - it: should render API configmap with default values
    values:
      - __fixtures__/base-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: braintrust-api
      - equal:
          path: data.ORG_NAME
          value: "test-org"
      - equal:
          path: data.BRAINSTORE_ENABLED
          value: "true"
      - equal:
          path: data.BRAINSTORE_DEFAULT
          value: "force"

  - it: should use correct namespace from helper when createNamespace is false
    values:
      - __fixtures__/base-values.yaml
    set:
      global.namespace: "custom-ns"
      global.createNamespace: false
    release:
      namespace: "release-namespace"
    asserts:
      - equal:
          path: metadata.namespace
          value: release-namespace

  - it: should use global namespace when createNamespace is true
    values:
      - __fixtures__/base-values.yaml
    set:
      global.namespace: "custom-ns"
      global.createNamespace: true
    release:
      namespace: "release-namespace"
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-ns

  - it: should configure AWS buckets when cloud is aws
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/aws-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: data.RESPONSE_BUCKET
          value: "test-response-bucket"
      - equal:
          path: data.CODE_BUNDLE_BUCKET
          value: "test-code-bundle-bucket"
      - equal:
          path: data.BRAINSTORE_REALTIME_WAL_BUCKET
          value: "test-brainstore-bucket"

  - it: should configure Azure storage when cloud is azure
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: data.AZURE_STORAGE_ACCOUNT_NAME
          value: "teststorageaccount"
      - equal:
          path: data.RESPONSE_BUCKET
          value: "responses"
      - equal:
          path: data.CODE_BUNDLE_BUCKET
          value: "code-bundles"
      - equal:
          path: data.BRAINSTORE_REALTIME_WAL_BUCKET
          value: "brainstore"
      - equal:
          path: data.BRAINSTORE_REALTIME_WAL_BUCKET_PREFIX
          value: "brainstore/wal"

  - it: should configure Google Cloud buckets when cloud is google
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/google-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: data.RESPONSE_BUCKET
          value: "test-api-bucket"
      - equal:
          path: data.RESPONSE_BUCKET_PREFIX
          value: "response/"
      - equal:
          path: data.CODE_BUNDLE_BUCKET
          value: "test-api-bucket"
      - equal:
          path: data.CODE_BUNDLE_BUCKET_PREFIX
          value: "code-bundle/"
      - equal:
          path: data.BRAINSTORE_REALTIME_WAL_BUCKET
          value: "test-brainstore-bucket"
      - equal:
          path: data.AWS_ENDPOINT_URL
          value: "https://storage.googleapis.com"

  - it: should configure brainstore URLs correctly
    values:
      - __fixtures__/base-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: data.BRAINSTORE_URL
          value: "http://brainstore-reader.braintrust:4000"
      - equal:
          path: data.BRAINSTORE_WRITER_URL
          value: "http://brainstore-writer.braintrust:4000"

  - it: should include control plane telemetry
    values:
      - __fixtures__/base-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: data.CONTROL_PLANE_TELEMETRY
          value: "status,metrics"

  - it: should merge global and api labels
    values:
      - __fixtures__/base-values.yaml
    set:
      api.labels.component: "api"
      global.labels.environment: "production"
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: metadata.labels.environment
          value: production
      - equal:
          path: metadata.labels.component
          value: api

  - it: should include configmap annotations when provided
    values:
      - __fixtures__/base-values.yaml
    set:
      api.annotations.configmap:
        custom-annotation: "value"
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: value

  - it: should configure backfill settings
    values:
      - __fixtures__/base-values.yaml
    set:
      api.backfillDisableHistorical: true
      api.backfillDisableNonhistorical: true
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: data.BRAINSTORE_BACKFILL_DISABLE_HISTORICAL
          value: "true"
      - equal:
          path: data.BRAINSTORE_BACKFILL_DISABLE_NONHISTORICAL
          value: "true"
