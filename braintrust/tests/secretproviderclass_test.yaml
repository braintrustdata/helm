suite: test SecretProviderClass template
templates:
  - secretproviderclass.yaml
tests:
  - it: should not render when cloud is not azure
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/google-values.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when cloud is aws
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/aws-values.yaml
    asserts:
      - hasDocuments:
          count: 0

  - it: should not render when cloud is azure but enableAzureKeyVaultDriver is false
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    set:
      azure.enableAzureKeyVaultDriver: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render SecretProviderClass when cloud is azure and enableAzureKeyVaultDriver is true
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: SecretProviderClass
      - equal:
          path: metadata.name
          value: test-keyvault

  - it: should use correct namespace from helper when createNamespace is false
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    set:
      global.namespace: "custom-ns"
      global.createNamespace: false
    release:
      namespace: "release-namespace"
    asserts:
      - equal:
          path: metadata.namespace
          value: release-namespace

  - it: should use global namespace when createNamespace is true
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    set:
      global.namespace: "custom-ns"
      global.createNamespace: true
    release:
      namespace: "release-namespace"
    asserts:
      - equal:
          path: metadata.namespace
          value: custom-ns

  - it: should configure Azure provider correctly
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: spec.provider
          value: azure
      - equal:
          path: spec.parameters.usePodIdentity
          value: "false"
      - equal:
          path: spec.parameters.useVMManagedIdentity
          value: "false"
      - equal:
          path: spec.parameters.keyvaultName
          value: test-keyvault
      - equal:
          path: spec.parameters.clientID
          value: test-client-id
      - equal:
          path: spec.parameters.tenantId
          value: test-tenant-id

  - it: should configure secret objects for kubernetes secret sync
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: spec.secretObjects[0].secretName
          value: braintrust-secrets
      - equal:
          path: spec.secretObjects[0].type
          value: Opaque
      - contains:
          path: spec.secretObjects[0].data
          content:
            key: REDIS_URL
            objectName: redis-connection-string
      - contains:
          path: spec.secretObjects[0].data
          content:
            key: PG_URL
            objectName: postgres-connection-string
      - contains:
          path: spec.secretObjects[0].data
          content:
            key: BRAINSTORE_LICENSE_KEY
            objectName: brainstore-license-key
      - contains:
          path: spec.secretObjects[0].data
          content:
            key: FUNCTION_SECRET_KEY
            objectName: function-secret-key
      - contains:
          path: spec.secretObjects[0].data
          content:
            key: AZURE_STORAGE_CONNECTION_STRING
            objectName: azure-storage-connection-string

  - it: should include global labels
    values:
      - __fixtures__/base-values.yaml
      - __fixtures__/azure-values.yaml
    set:
      global.labels.environment: "production"
    release:
      namespace: "braintrust"
    asserts:
      - equal:
          path: metadata.labels.environment
          value: production
