suite: test label merge isolation for services (deepCopy fix)
templates:
  - api-service.yaml
  - brainstore-reader-service.yaml
  - brainstore-writer-service.yaml
tests:
  # These tests verify the deepCopy fix for services.
  # Without deepCopy, labels would bleed between components due to merge mutation.

  - it: should give API service only global and api-specific labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.shared: "global-service"
      global.labels.environment: "production"
      api.labels.component: "api"
      api.labels.api-specific: "api-svc"
      brainstore.reader.labels.component: "reader"
      brainstore.reader.labels.reader-specific: "reader-svc"
      brainstore.writer.labels.component: "writer"
      brainstore.writer.labels.writer-specific: "writer-svc"
    release:
      namespace: "braintrust"
    template: api-service.yaml
    asserts:
      - equal:
          path: metadata.labels.shared
          value: global-service
      - equal:
          path: metadata.labels.component
          value: api
      - equal:
          path: metadata.labels["api-specific"]
          value: api-svc
      - isNull:
          path: metadata.labels["reader-specific"]
      - isNull:
          path: metadata.labels["writer-specific"]

  - it: should give Reader service only global and reader-specific labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.shared: "global-service"
      api.labels.api-specific: "api-svc"
      brainstore.reader.labels.reader-specific: "reader-svc"
      brainstore.writer.labels.writer-specific: "writer-svc"
    release:
      namespace: "braintrust"
    template: brainstore-reader-service.yaml
    asserts:
      - equal:
          path: metadata.labels.shared
          value: global-service
      - equal:
          path: metadata.labels["reader-specific"]
          value: reader-svc
      - isNull:
          path: metadata.labels["api-specific"]
      - isNull:
          path: metadata.labels["writer-specific"]

  - it: should give Writer service only global and writer-specific labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.shared: "global-service"
      api.labels.api-specific: "api-svc"
      brainstore.reader.labels.reader-specific: "reader-svc"
      brainstore.writer.labels.writer-specific: "writer-svc"
    release:
      namespace: "braintrust"
    template: brainstore-writer-service.yaml
    asserts:
      - equal:
          path: metadata.labels.shared
          value: global-service
      - equal:
          path: metadata.labels["writer-specific"]
          value: writer-svc
      - isNull:
          path: metadata.labels["api-specific"]
      - isNull:
          path: metadata.labels["reader-specific"]
