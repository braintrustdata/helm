suite: test label merge isolation (deepCopy fix)
templates:
  - api-deployment.yaml
  - brainstore-reader-deployment.yaml
  - brainstore-writer-deployment.yaml
tests:
  # This test verifies that labels are isolated between components.
  # The bug that was fixed: Helm's merge function mutates the leftmost dict,
  # so without deepCopy, if api.labels, reader.labels, and writer.labels
  # are different, the last rendered component's labels would bleed into
  # earlier components through the mutated global.labels.
  #
  # The fix uses deepCopy to prevent mutation:
  #   merge (deepCopy .Values.global.labels) .Values.api.labels

  - it: should give API deployment only global and api-specific labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.shared: "global-value"
      global.labels.environment: "production"
      api.labels.component: "api"
      api.labels.api-specific: "api-only"
      brainstore.reader.labels.component: "reader"
      brainstore.reader.labels.reader-specific: "reader-only"
      brainstore.writer.labels.component: "writer"
      brainstore.writer.labels.writer-specific: "writer-only"
    release:
      namespace: "braintrust"
    template: api-deployment.yaml
    asserts:
      # API deployment should have global labels
      - equal:
          path: metadata.labels.shared
          value: global-value
      - equal:
          path: metadata.labels.environment
          value: production
      # API deployment should have api-specific labels
      - equal:
          path: metadata.labels.component
          value: api
      - equal:
          path: metadata.labels["api-specific"]
          value: api-only
      # API deployment should NOT have reader or writer specific labels
      - isNull:
          path: metadata.labels["reader-specific"]
      - isNull:
          path: metadata.labels["writer-specific"]
      # Pod template labels should also be isolated
      - equal:
          path: spec.template.metadata.labels.shared
          value: global-value
      - equal:
          path: spec.template.metadata.labels["api-specific"]
          value: api-only
      - isNull:
          path: spec.template.metadata.labels["reader-specific"]
      - isNull:
          path: spec.template.metadata.labels["writer-specific"]

  - it: should give Reader deployment only global and reader-specific labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.shared: "global-value"
      global.labels.environment: "production"
      api.labels.component: "api"
      api.labels.api-specific: "api-only"
      brainstore.reader.labels.component: "reader"
      brainstore.reader.labels.reader-specific: "reader-only"
      brainstore.writer.labels.component: "writer"
      brainstore.writer.labels.writer-specific: "writer-only"
    release:
      namespace: "braintrust"
    template: brainstore-reader-deployment.yaml
    asserts:
      # Reader deployment should have global labels
      - equal:
          path: metadata.labels.shared
          value: global-value
      - equal:
          path: metadata.labels.environment
          value: production
      # Reader deployment should have reader-specific labels
      - equal:
          path: metadata.labels.component
          value: reader
      - equal:
          path: metadata.labels["reader-specific"]
          value: reader-only
      # Reader deployment should NOT have api or writer specific labels
      - isNull:
          path: metadata.labels["api-specific"]
      - isNull:
          path: metadata.labels["writer-specific"]
      # Pod template labels should also be isolated
      - equal:
          path: spec.template.metadata.labels.shared
          value: global-value
      - equal:
          path: spec.template.metadata.labels["reader-specific"]
          value: reader-only
      - isNull:
          path: spec.template.metadata.labels["api-specific"]
      - isNull:
          path: spec.template.metadata.labels["writer-specific"]

  - it: should give Writer deployment only global and writer-specific labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.shared: "global-value"
      global.labels.environment: "production"
      api.labels.component: "api"
      api.labels.api-specific: "api-only"
      brainstore.reader.labels.component: "reader"
      brainstore.reader.labels.reader-specific: "reader-only"
      brainstore.writer.labels.component: "writer"
      brainstore.writer.labels.writer-specific: "writer-only"
    release:
      namespace: "braintrust"
    template: brainstore-writer-deployment.yaml
    asserts:
      # Writer deployment should have global labels
      - equal:
          path: metadata.labels.shared
          value: global-value
      - equal:
          path: metadata.labels.environment
          value: production
      # Writer deployment should have writer-specific labels
      - equal:
          path: metadata.labels.component
          value: writer
      - equal:
          path: metadata.labels["writer-specific"]
          value: writer-only
      # Writer deployment should NOT have api or reader specific labels
      - isNull:
          path: metadata.labels["api-specific"]
      - isNull:
          path: metadata.labels["reader-specific"]
      # Pod template labels should also be isolated
      - equal:
          path: spec.template.metadata.labels.shared
          value: global-value
      - equal:
          path: spec.template.metadata.labels["writer-specific"]
          value: writer-only
      - isNull:
          path: spec.template.metadata.labels["api-specific"]
      - isNull:
          path: spec.template.metadata.labels["reader-specific"]

  - it: should propagate global labels to API without component labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.environment: "staging"
      global.labels.team: "platform"
    release:
      namespace: "braintrust"
    template: api-deployment.yaml
    asserts:
      - equal:
          path: metadata.labels.environment
          value: staging
      - equal:
          path: metadata.labels.team
          value: platform

  - it: should propagate global labels to Reader without component labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.environment: "staging"
      global.labels.team: "platform"
    release:
      namespace: "braintrust"
    template: brainstore-reader-deployment.yaml
    asserts:
      - equal:
          path: metadata.labels.environment
          value: staging
      - equal:
          path: metadata.labels.team
          value: platform

  - it: should propagate global labels to Writer without component labels
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.environment: "staging"
      global.labels.team: "platform"
    release:
      namespace: "braintrust"
    template: brainstore-writer-deployment.yaml
    asserts:
      - equal:
          path: metadata.labels.environment
          value: staging
      - equal:
          path: metadata.labels.team
          value: platform

  # Note: Helm's merge function gives precedence to the destination (first argument).
  # With `merge (deepCopy .Values.component.labels) .Values.global.labels`,
  # component labels take precedence over global labels when keys conflict.
  # Global labels are only added if the key doesn't exist in component labels.

  - it: should give component labels precedence over global labels when keys conflict (API)
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.tier: "global-tier"
      api.labels.tier: "api-tier"
      api.labels.api-only: "api-value"
    release:
      namespace: "braintrust"
    template: api-deployment.yaml
    asserts:
      # Component label takes precedence for conflicting key
      - equal:
          path: metadata.labels.tier
          value: api-tier
      # Non-conflicting component label is still added
      - equal:
          path: metadata.labels["api-only"]
          value: api-value

  - it: should give component labels precedence over global labels when keys conflict (Reader)
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.tier: "global-tier"
      brainstore.reader.labels.tier: "reader-tier"
      brainstore.reader.labels.reader-only: "reader-value"
    release:
      namespace: "braintrust"
    template: brainstore-reader-deployment.yaml
    asserts:
      # Component label takes precedence for conflicting key
      - equal:
          path: metadata.labels.tier
          value: reader-tier
      # Non-conflicting component label is still added
      - equal:
          path: metadata.labels["reader-only"]
          value: reader-value

  - it: should give component labels precedence over global labels when keys conflict (Writer)
    values:
      - __fixtures__/base-values.yaml
    set:
      global.labels.tier: "global-tier"
      brainstore.writer.labels.tier: "writer-tier"
      brainstore.writer.labels.writer-only: "writer-value"
    release:
      namespace: "braintrust"
    template: brainstore-writer-deployment.yaml
    asserts:
      # Component label takes precedence for conflicting key
      - equal:
          path: metadata.labels.tier
          value: writer-tier
      # Non-conflicting component label is still added
      - equal:
          path: metadata.labels["writer-only"]
          value: writer-value
